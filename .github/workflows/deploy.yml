name: Deploy Run (run.movmais.com) - COM DEBUG

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: "üìç Conectar ao servidor"
        uses: appleboy/ssh-action@master
        env:
          ENV: ${{ secrets.ENV }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          envs: ENV
          script: |
            set -e

            echo "=========================================="
            echo "üöÄ INICIANDO DEPLOY DO RUN"
            echo "=========================================="
            echo ""

            echo "üìç Data/Hora do deploy"
            date
            echo ""

            echo "üìç Verificar diret√≥rio"
            pwd
            ls -la /opt/movmais/apps/ || true
            echo ""

            echo "üìç Vers√£o atual no servidor (ANTES do deploy)"
            cd /opt/movmais/apps/run
            echo "Commit atual:"
            git log -1 --oneline || true
            echo "Branch:"
            git branch --show-current 2>/dev/null || git branch || true
            echo ""

            echo "üìç Atualizar c√≥digo do GitHub"
            git fetch origin
            echo "Commits dispon√≠veis:"
            git log -3 --oneline || true
            echo ""

            echo "üìç Fazer reset hard para origin/main"
            git reset --hard origin/main
            echo "‚úÖ Reset conclu√≠do"
            echo ""

            echo "üìç Vers√£o AP√ìS git reset"
            git log -1 --oneline || true
            echo ""

            echo "üìç Verificar arquivos alterados"
            git status || true
            echo ""

            echo "üìç Verificar conte√∫do de arquivo importante (package.json)"
            head -5 package.json || true
            echo ""

            echo "=========================================="
            echo "üìù CRIAR ARQUIVO .ENV (VINDO DO GITHUB SECRET)"
            echo "=========================================="
            echo ""

            cd /opt/movmais/apps/run

            # escreve exatamente o conte√∫do do secret ENV, preservando quebras de linha
            printf '%s' "$ENV" > .env
            echo "" >> .env

            echo "‚úÖ .env atualizado a partir de secrets.ENV"
            echo ""

            # N√£o vazar segredos no log (mostra s√≥ as chaves)
            echo "üìç Chaves do .env (sem valores):"
            awk -F= '/^[A-Za-z_][A-Za-z0-9_]*=/{print $1}' .env | sort || true
            echo ""

            echo "=========================================="
            echo "üê≥ DOCKER BUILD"
            echo "=========================================="
            cd /opt/movmais
            echo ""

            echo "üìç Remover imagem antiga"
            docker rmi movmais-run -f || echo "Nenhuma imagem anterior"
            echo ""

            echo "üìç Parar container antigo"
            docker-compose stop run || echo "Container n√£o estava rodando"
            echo ""

            echo "üìç Iniciar build (sem cache)"
            docker-compose build --no-cache run
            echo ""

            echo "=========================================="
            echo "üöÄ INICIAR CONTAINER"
            echo "=========================================="
            docker-compose up -d run
            echo ""

            echo "üìç Aguardar 5 segundos para container iniciar"
            sleep 5
            echo ""

            echo "üìç Status dos containers"
            docker-compose ps || true
            echo ""

            echo "üìç Logs do container (√∫ltimas 30 linhas)"
            docker logs movmais-run | tail -30 || true
            echo ""

            echo "=========================================="
            echo "‚úÖ VERIFICA√á√ïES FINAIS"
            echo "=========================================="

            echo "üìç Verificar vers√£o no servidor (AP√ìS deploy)"
            cd /opt/movmais/apps/run
            echo "Commit atual:"
            git log -1 --oneline || true
            echo ""

            echo "üìç Verificar se container est√° rodando"
            docker-compose ps run || true
            echo ""

            echo "üìç Testar acesso ao Run"
            curl -s -I http://127.0.0.1:3030/ | head -3 || true
            echo ""

            echo "üìç Verificar porta 3030 est√° aberta"
            netstat -tlnp 2>/dev/null | grep 3030 || echo "‚ö†Ô∏è Porta 3030 n√£o encontrada"
            echo ""

            echo "=========================================="
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
            echo "=========================================="
            echo "Timestamp: $(date)"
            echo "URL: https://run.movmais.com"
            echo "=========================================="
